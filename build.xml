<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE project>
<project name="CyclesMod" default="release">

	<property environment="env" />
	<property name="env.JRE6_HOME" value="${env.JAVA_HOME}/../jdk1.6.0_45/jre" />

	<property file="build.properties" />
	<property file="${build.resourcesDirectory}/version.properties" />

	<!-- JarBundler configuration -->
	<taskdef name="jarbundler" classname="com.ultramixer.jarbundler.JarBundler" classpath="${jarbundler.dir}/jarbundler-core-3.3.0.jar" />

	<!-- Launch4j configuration -->
	<taskdef name="launch4j" classname="net.sf.launch4j.ant.Launch4jTask" classpath="${launch4j.dir}/launch4j.jar:${launch4j.dir}/lib/xstream.jar" />
	<condition property="launch4j.bindir" value="${launch4j.dir}/mac" else="${launch4j.dir}/bin">
		<and>
			<os family="mac" />
			<available file="${launch4j.dir}/mac" type="dir" />
		</and>
	</condition>
	<chmod perm="+x" file="${launch4j.bindir}/*" failonerror="false" failifexecutionfails="false" ignoremissing="true" />

	<target name="clean">
		<delete dir="${build.directory}" />
	</target>

	<target name="compile" depends="clean">
		<mkdir dir="${build.outputDirectory}" />
		<javac srcdir="${build.sourceDirectory}" destdir="${build.outputDirectory}" source="${build.compiler.source}" target="${build.compiler.target}" debug="true" includeantruntime="false">
			<classpath>
				<fileset dir="${dependencies.directory}">
					<include name="**/*.jar" />
				</fileset>
			</classpath>
			<!-- Compilazione per JRE specifico -->
			<bootclasspath path="${build.compiler.compilerArguments.bootclasspath}" />
		</javac>
	</target>

	<target name="resources">
		<copy todir="${build.outputDirectory}">
			<fileset dir="${build.resourcesDirectory}" />
		</copy>
	</target>

	<target name="lib">
		<fileset id="lib" dir="${dependencies.directory}">
			<include name="*.jar" />
			<include name="license/*.txt" />
		</fileset>

		<!-- Copia dei file JAR delle librerie -->
		<copy todir="${build.distDirectory}/win32-win32-x86/${artifactId}/lib">
			<fileset refid="lib" />
			<fileset dir="${dependencies.directory}/os/win32-win32-x86">
				<include name="*.jar" />
			</fileset>
		</copy>
		<copy todir="${build.distDirectory}/win32-win32-x86_64/${artifactId}/lib">
			<fileset refid="lib" />
			<fileset dir="${dependencies.directory}/os/win32-win32-x86_64">
				<include name="*.jar" />
			</fileset>
		</copy>
		<copy todir="${build.distDirectory}/gtk-linux-x86/${artifactId}/lib">
			<fileset refid="lib" />
			<fileset dir="${dependencies.directory}/os/gtk-linux-x86">
				<include name="*.jar" />
			</fileset>
		</copy>
		<copy todir="${build.distDirectory}/gtk-linux-x86_64/${artifactId}/lib">
			<fileset refid="lib" />
			<fileset dir="${dependencies.directory}/os/gtk-linux-x86_64">
				<include name="*.jar" />
			</fileset>
		</copy>
		<copy todir="${build.distDirectory}/cocoa-macosx/${artifactId}/lib">
			<fileset refid="lib" />
			<fileset dir="${dependencies.directory}/os/cocoa-macosx">
				<include name="*.jar" />
			</fileset>
		</copy>
		<copy todir="${build.distDirectory}/cocoa-macosx-x86_64/${artifactId}/lib">
			<fileset refid="lib" />
			<fileset dir="${dependencies.directory}/os/cocoa-macosx-x86_64">
				<include name="*.jar" />
			</fileset>
		</copy>
		<copy todir="${build.distDirectory}/other/${artifactId}/lib">
			<fileset refid="lib" />
		</copy>

		<!-- Preparazione dei file MANIFEST.MF -->
		<manifestclasspath property="classpath.win32-win32-x86" jarfile="${build.distDirectory}/win32-win32-x86/${artifactId}/${artifactId}.jar" maxParentLevels="0">
			<classpath>
				<fileset dir="${build.distDirectory}/win32-win32-x86/${artifactId}/lib">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</manifestclasspath>
		<manifestclasspath property="classpath.win32-win32-x86_64" jarfile="${build.distDirectory}/win32-win32-x86_64/${artifactId}/${artifactId}.jar" maxParentLevels="0">
			<classpath>
				<fileset dir="${build.distDirectory}/win32-win32-x86_64/${artifactId}/lib">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</manifestclasspath>
		<manifestclasspath property="classpath.gtk-linux-x86" jarfile="${build.distDirectory}/gtk-linux-x86/${artifactId}/${artifactId}.jar" maxParentLevels="0">
			<classpath>
				<fileset dir="${build.distDirectory}/gtk-linux-x86/${artifactId}/lib">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</manifestclasspath>
		<manifestclasspath property="classpath.gtk-linux-x86_64" jarfile="${build.distDirectory}/gtk-linux-x86_64/${artifactId}/${artifactId}.jar" maxParentLevels="0">
			<classpath>
				<fileset dir="${build.distDirectory}/gtk-linux-x86_64/${artifactId}/lib">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</manifestclasspath>
		<manifestclasspath property="classpath.cocoa-macosx" jarfile="${build.distDirectory}/cocoa-macosx/${artifactId}/${artifactId}.jar" maxParentLevels="0">
			<classpath>
				<fileset dir="${build.distDirectory}/cocoa-macosx/${artifactId}/lib">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</manifestclasspath>
		<manifestclasspath property="classpath.cocoa-macosx-x86_64" jarfile="${build.distDirectory}/cocoa-macosx-x86_64/${artifactId}/${artifactId}.jar" maxParentLevels="0">
			<classpath>
				<fileset dir="${build.distDirectory}/cocoa-macosx-x86_64/${artifactId}/lib">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</manifestclasspath>
		<manifestclasspath property="classpath.other" jarfile="${build.distDirectory}/other/${artifactId}/${artifactId}.jar" maxParentLevels="0">
			<classpath>
				<fileset dir="${build.distDirectory}/other/${artifactId}/lib">
					<include name="*.jar" />
				</fileset>
			</classpath>
		</manifestclasspath>
	</target>

	<target name="config">
		<fileset id="config" dir="${build.configDirectory}" />

		<copy todir="${build.distDirectory}/win32-win32-x86/${artifactId}" failonerror="false">
			<fileset refid="config" />
		</copy>
		<copy todir="${build.distDirectory}/win32-win32-x86_64/${artifactId}" failonerror="false">
			<fileset refid="config" />
		</copy>
		<copy todir="${build.distDirectory}/gtk-linux-x86/${artifactId}" failonerror="false">
			<fileset refid="config" />
		</copy>
		<copy todir="${build.distDirectory}/gtk-linux-x86_64/${artifactId}" failonerror="false">
			<fileset refid="config" />
		</copy>
		<copy todir="${build.distDirectory}/cocoa-macosx/${artifactId}" failonerror="false">
			<fileset refid="config" />
		</copy>
		<copy todir="${build.distDirectory}/cocoa-macosx-x86_64/${artifactId}" failonerror="false">
			<fileset refid="config" />
		</copy>
		<copy todir="${build.distDirectory}/other/${artifactId}" failonerror="false">
			<fileset refid="config" />
		</copy>
	</target>

	<target name="scripts">
		<fileset id="bat" dir="${build.scriptSourceDirectory}">
			<include name="*.bat" />
		</fileset>
		<fileset id="sh" dir="${build.scriptSourceDirectory}">
			<include name="*.sh" />
		</fileset>
		<fileset id="command" dir="${build.scriptSourceDirectory}">
			<include name="*.command" />
		</fileset>

		<copy todir="${build.distDirectory}/win32-win32-x86/${artifactId}" failonerror="false">
			<fileset refid="bat" />
		</copy>
		<copy todir="${build.distDirectory}/win32-win32-x86_64/${artifactId}" failonerror="false">
			<fileset refid="bat" />
		</copy>
		<copy todir="${build.distDirectory}/gtk-linux-x86/${artifactId}" failonerror="false">
			<fileset refid="sh" />
		</copy>
		<copy todir="${build.distDirectory}/gtk-linux-x86_64/${artifactId}" failonerror="false">
			<fileset refid="sh" />
		</copy>
		<copy todir="${build.distDirectory}/cocoa-macosx/${artifactId}" failonerror="false">
			<fileset refid="command" />
		</copy>
		<copy todir="${build.distDirectory}/cocoa-macosx-x86_64/${artifactId}" failonerror="false">
			<fileset refid="command" />
		</copy>
		<copy todir="${build.distDirectory}/other/${artifactId}" failonerror="false">
			<fileset refid="bat" />
			<fileset refid="sh" />
			<fileset refid="command" />
		</copy>
	</target>

	<fileset id="docs" dir="">
		<include name="README*" />
		<include name="LICENSE*" />
		<include name="NOTICE*" />
	</fileset>

	<target name="docs">
		<copy todir="${build.distDirectory}/win32-win32-x86/${artifactId}">
			<fileset refid="docs" />
		</copy>
		<copy todir="${build.distDirectory}/win32-win32-x86_64/${artifactId}">
			<fileset refid="docs" />
		</copy>
		<copy todir="${build.distDirectory}/gtk-linux-x86/${artifactId}">
			<fileset refid="docs" />
		</copy>
		<copy todir="${build.distDirectory}/gtk-linux-x86_64/${artifactId}">
			<fileset refid="docs" />
		</copy>
		<copy todir="${build.distDirectory}/cocoa-macosx/${artifactId}">
			<fileset refid="docs" />
		</copy>
		<copy todir="${build.distDirectory}/cocoa-macosx-x86_64/${artifactId}">
			<fileset refid="docs" />
		</copy>
		<copy todir="${build.distDirectory}/other/${artifactId}">
			<fileset refid="docs" />
		</copy>
	</target>

	<target name="icons">
		<copy file="${icons.directory}/main.ico" tofile="${build.distDirectory}/gtk-linux-x86/${artifactId}/${artifactId}.icns" failonerror="false" />
		<copy file="${icons.directory}/main.ico" tofile="${build.distDirectory}/gtk-linux-x86_64/${artifactId}/${artifactId}.icns" failonerror="false" />
		<copy file="${icons.directory}/main.icns" tofile="${build.distDirectory}/cocoa-macosx/${artifactId}/${artifactId}.icns" failonerror="false" />
		<copy file="${icons.directory}/main.icns" tofile="${build.distDirectory}/cocoa-macosx-x86_64/${artifactId}/${artifactId}.icns" failonerror="false" />
		<copy file="${icons.directory}/main.icns" tofile="${build.distDirectory}/other/${artifactId}/${artifactId}.icns" failonerror="false" />
		<copy file="${icons.directory}/main.ico" tofile="${build.distDirectory}/other/${artifactId}/${artifactId}.ico" failonerror="false" />
	</target>

	<target name="jar" depends="compile, resources, config, scripts, docs, icons, lib">
		<jar destfile="${build.distDirectory}/win32-win32-x86/${artifactId}/${artifactId}.jar" basedir="${build.outputDirectory}" level="9">
			<manifest>
				<attribute name="Main-Class" value="${build.jar.archive.manifest.mainClass}" />
				<attribute name="Class-Path" value="${classpath.win32-win32-x86}" />
			</manifest>
			<metainf refid="docs" />
		</jar>
		<jar destfile="${build.distDirectory}/win32-win32-x86_64/${artifactId}/${artifactId}.jar" basedir="${build.outputDirectory}" level="9">
			<manifest>
				<attribute name="Main-Class" value="${build.jar.archive.manifest.mainClass}" />
				<attribute name="Class-Path" value="${classpath.win32-win32-x86_64}" />
			</manifest>
			<metainf refid="docs" />
		</jar>
		<jar destfile="${build.distDirectory}/gtk-linux-x86/${artifactId}/${artifactId}.jar" basedir="${build.outputDirectory}" level="9">
			<manifest>
				<attribute name="Main-Class" value="${build.jar.archive.manifest.mainClass}" />
				<attribute name="Class-Path" value="${classpath.gtk-linux-x86}" />
			</manifest>
			<metainf refid="docs" />
		</jar>
		<jar destfile="${build.distDirectory}/gtk-linux-x86_64/${artifactId}/${artifactId}.jar" basedir="${build.outputDirectory}" level="9">
			<manifest>
				<attribute name="Main-Class" value="${build.jar.archive.manifest.mainClass}" />
				<attribute name="Class-Path" value="${classpath.gtk-linux-x86_64}" />
			</manifest>
			<metainf refid="docs" />
		</jar>
		<jar destfile="${build.distDirectory}/cocoa-macosx/${artifactId}/${artifactId}.jar" basedir="${build.outputDirectory}" level="9">
			<manifest>
				<attribute name="Main-Class" value="${build.jar.archive.manifest.mainClass}" />
				<attribute name="Class-Path" value="${classpath.cocoa-macosx}" />
			</manifest>
			<metainf refid="docs" />
		</jar>
		<jar destfile="${build.distDirectory}/cocoa-macosx-x86_64/${artifactId}/${artifactId}.jar" basedir="${build.outputDirectory}" level="9">
			<manifest>
				<attribute name="Main-Class" value="${build.jar.archive.manifest.mainClass}" />
				<attribute name="Class-Path" value="${classpath.cocoa-macosx-x86_64}" />
			</manifest>
			<metainf refid="docs" />
		</jar>
		<jar destfile="${build.distDirectory}/other/${artifactId}/${artifactId}.jar" basedir="${build.outputDirectory}" level="9">
			<manifest>
				<attribute name="Main-Class" value="${build.jar.archive.manifest.mainClass}" />
				<attribute name="Class-Path" value="${classpath.other}" />
			</manifest>
			<metainf refid="docs" />
		</jar>
	</target>

	<target name="release" depends="jar">
		<!-- Mac OS X -->
		<mkdir dir="${build.directory}/bundle/cocoa-macosx" />
		<jarbundler vmoptions="${macosx.vmoptions}" dir="${build.directory}/bundle/cocoa-macosx" name="${name}" mainclass="${build.jar.archive.manifest.mainClass}" startonmainthread="true" version="${version.number}" icon="${build.distDirectory}/cocoa-macosx/${artifactId}/${artifactId}.icns" usejavaxkey="true" jvmversion="${build.compiler.target}+" stubfile="${jarbundler.dir}/JavaApplicationStub" highresolutioncapable="true">
			<jarfileset dir="${build.distDirectory}/cocoa-macosx/${artifactId}" includes="**/*.jar" />
		</jarbundler>
		<copy todir="${build.directory}/bundle/cocoa-macosx/${name}.app/Contents/Resources/Java" failonerror="false">
			<fileset refid="config" />
			<fileset refid="command" />
		</copy>
		<copy todir="${build.directory}/bundle/cocoa-macosx/${name}.app/Contents/SharedSupport">
			<fileset refid="docs" />
		</copy>
		<tar destfile="${build.releaseDirectory}/${artifactId}-${version.number}-cocoa-macosx-bin.tar.gz" compression="gzip">
			<tarfileset dir="${build.directory}/bundle/cocoa-macosx" filemode="755">
				<include name="${name}.app/Contents/MacOS/*" />
				<include name="${name}.app/Contents/Resources/Java/*.command" />
			</tarfileset>
			<tarfileset dir="${build.directory}/bundle/cocoa-macosx">
				<include name="**" />
				<exclude name="${name}.app/Contents/MacOS/*" />
				<exclude name="${name}.app/Contents/Resources/Java/*.command" />
			</tarfileset>
		</tar>

		<mkdir dir="${build.directory}/bundle/cocoa-macosx-x86_64" />
		<jarbundler vmoptions="${macosx.vmoptions}" dir="${build.directory}/bundle/cocoa-macosx-x86_64" name="${name}" mainclass="${build.jar.archive.manifest.mainClass}" startonmainthread="true" version="${version.number}" icon="${build.distDirectory}/cocoa-macosx-x86_64/${artifactId}/${artifactId}.icns" usejavaxkey="true" jvmversion="${build.compiler.target}+" stubfile="${jarbundler.dir}/JavaApplicationStub" highresolutioncapable="true">
			<jarfileset dir="${build.distDirectory}/cocoa-macosx-x86_64/${artifactId}" includes="**/*.jar" />
		</jarbundler>
		<copy todir="${build.directory}/bundle/cocoa-macosx-x86_64/${name}.app/Contents/Resources/Java" failonerror="false">
			<fileset refid="config" />
			<fileset refid="command" />
		</copy>
		<copy todir="${build.directory}/bundle/cocoa-macosx-x86_64/${name}.app/Contents/SharedSupport">
			<fileset refid="docs" />
		</copy>
		<tar destfile="${build.releaseDirectory}/${artifactId}-${version.number}-cocoa-macosx-x86_64-bin.tar.gz" compression="gzip">
			<tarfileset dir="${build.directory}/bundle/cocoa-macosx-x86_64" filemode="755">
				<include name="${name}.app/Contents/MacOS/*" />
				<include name="${name}.app/Contents/Resources/Java/*.command" />
			</tarfileset>
			<tarfileset dir="${build.directory}/bundle/cocoa-macosx-x86_64">
				<include name="**" />
				<exclude name="${name}.app/Contents/MacOS/*" />
				<exclude name="${name}.app/Contents/Resources/Java/*.command" />
			</tarfileset>
		</tar>

		<!-- Linux -->
		<tar destfile="${build.releaseDirectory}/${artifactId}-${version.number}-gtk-linux-x86-bin.tar.gz" compression="gzip">
			<tarfileset dir="${build.distDirectory}/gtk-linux-x86" filemode="755">
				<include name="${artifactId}/*.jar" />
				<include name="${artifactId}/*.sh" />
			</tarfileset>
			<tarfileset dir="${build.distDirectory}/gtk-linux-x86">
				<include name="**" />
				<exclude name="${artifactId}/*.jar" />
				<exclude name="${artifactId}/*.sh" />
			</tarfileset>
		</tar>
		<tar destfile="${build.releaseDirectory}/${artifactId}-${version.number}-gtk-linux-x86_64-bin.tar.gz" compression="gzip">
			<tarfileset dir="${build.distDirectory}/gtk-linux-x86_64" filemode="755">
				<include name="${artifactId}/*.jar" />
				<include name="${artifactId}/*.sh" />
			</tarfileset>
			<tarfileset dir="${build.distDirectory}/gtk-linux-x86_64">
				<include name="**" />
				<exclude name="${artifactId}/*.jar" />
				<exclude name="${artifactId}/*.sh" />
			</tarfileset>
		</tar>

		<!-- Windows -->
		<launch4j bindir="${launch4j.bindir}">
			<config outfile="${build.distDirectory}/win32-win32-x86/${artifactId}/${artifactId}.exe" jarpath="${artifactId}.jar" headertype="${launch4j.headerType}" dontwrapjar="${launch4j.dontWrapJar}" stayalive="${launch4j.stayAlive}" restartoncrash="${launch4j.restartOnCrash}" priority="${launch4j.priority}" errtitle="${launch4j.errTitle}" chdir="." icon="${icons.directory}/main.ico">
				<singleInstance mutexname="${build.jar.archive.manifest.mainClass}" windowtitle="${name}" />
				<jre runtimebits="32" minversion="${build.compiler.target}.0" jdkpreference="${launch4j.jdkPreference}" initialheapsize="${vm.initialHeapSize}" maxheapsize="${vm.maxHeapSize}" />
				<classPath mainclass="${build.jar.archive.manifest.mainClass}" cp="lib/*" />
				<versionInfo fileversion="${version.number}.0" txtfileversion="${version.number}" filedescription="${name}" copyright="${name}" productversion="${version.number}.0" txtproductversion="${version.number}" productname="${name}" internalname="${artifactId}" originalfilename="${artifactId}.exe" />
			</config>
		</launch4j>
		<zip destfile="${build.releaseDirectory}/${artifactId}-${version.number}-win32-win32-x86-bin.zip" basedir="${build.distDirectory}/win32-win32-x86" level="9" />

		<launch4j bindir="${launch4j.bindir}">
			<config outfile="${build.distDirectory}/win32-win32-x86_64/${artifactId}/${artifactId}.exe" jarpath="${artifactId}.jar" headertype="${launch4j.headerType}" dontwrapjar="${launch4j.dontWrapJar}" stayalive="${launch4j.stayAlive}" restartoncrash="${launch4j.restartOnCrash}" priority="${launch4j.priority}" errtitle="${launch4j.errTitle}" chdir="." icon="${icons.directory}/main.ico">
				<singleInstance mutexname="${build.jar.archive.manifest.mainClass}" windowtitle="${name}" />
				<jre runtimebits="64" minversion="${build.compiler.target}.0" jdkpreference="${launch4j.jdkPreference}" initialheapsize="${vm.initialHeapSize}" maxheapsize="${vm.maxHeapSize}" />
				<classPath mainclass="${build.jar.archive.manifest.mainClass}" cp="lib/*" />
				<versionInfo fileversion="${version.number}.0" txtfileversion="${version.number}" filedescription="${name}" copyright="${name}" productversion="${version.number}.0" txtproductversion="${version.number}" productname="${name}" internalname="${artifactId}" originalfilename="${artifactId}.exe" />
			</config>
		</launch4j>
		<zip destfile="${build.releaseDirectory}/${artifactId}-${version.number}-win32-win32-x86_64-bin.zip" basedir="${build.distDirectory}/win32-win32-x86_64" level="9" />

		<!-- Other -->
		<tar destfile="${build.releaseDirectory}/${artifactId}-${version.number}-other-bin.tar.gz" compression="gzip">
			<tarfileset dir="${build.distDirectory}/other" filemode="755">
				<include name="${artifactId}/*.jar" />
				<include name="${artifactId}/*.sh" />
			</tarfileset>
			<tarfileset dir="${build.distDirectory}/other">
				<include name="**" />
				<exclude name="${artifactId}/*.jar" />
				<exclude name="${artifactId}/*.sh" />
			</tarfileset>
		</tar>
	</target>

</project>
